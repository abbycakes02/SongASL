{"ast":null,"code":"import { getCoordsDataType } from './shader_compiler';\nexport class CumSumProgram {\n  constructor(shape, exclusive, reverse) {\n    this.variableNames = ['x'];\n    this.outputShape = shape;\n    const rank = shape.length;\n    const val = exclusive ? '0.0' : `getX(${getCoords(rank, 'coords')})`;\n    const length = shape[shape.length - 1];\n    let condition = '';\n    let idxString = '';\n    // When exclusive is set, the cumsum op becomes roll op that copies the\n    // value from the previous index based on the direction specified by the\n    // reverse flag.\n    if (exclusive) {\n      condition = reverse ? `end != ${length - 1}` : 'end != 0';\n      idxString = reverse ? 'end + 1' : 'end - 1';\n    } else {\n      condition = reverse ? `end + pow2 < ${length}` : 'end >= pow2';\n      idxString = reverse ? 'end + pow2' : 'end - pow2';\n    }\n    this.userCode = `\n      uniform float index;\n      void main() {\n        ${getCoordsDataType(rank)} coords = getOutputCoords();\n        int end = ${getFinalCoord(rank, 'coords')};\n        float val = ${val};\n        int pow2 = int(pow(2.0, index));\n        if (${condition}) {\n          int idx = ${idxString};\n          ${getFinalCoord(rank, 'coords')} = idx;\n          val += getX(${getCoords(rank, 'coords')});\n        }\n        setOutput(val);\n      }\n    `;\n  }\n  getCustomSetupFunc(index) {\n    return (gpgpu, webGLProgram) => {\n      if (this.index == null) {\n        this.index = gpgpu.getUniformLocation(webGLProgram, 'index');\n      }\n      gpgpu.gl.uniform1f(this.index, index);\n    };\n  }\n}\nfunction getCoords(rank, name) {\n  if (rank === 1) {\n    return `${name}`;\n  } else if (rank === 2) {\n    return `${name}.x, ${name}.y`;\n  } else if (rank === 3) {\n    return `${name}.x, ${name}.y, ${name}.z`;\n  } else if (rank === 4) {\n    return `${name}.x, ${name}.y, ${name}.z, ${name}.w`;\n  } else {\n    throw Error(`Cumulative sum for rank ${rank} is not yet supported`);\n  }\n}\nfunction getFinalCoord(rank, name) {\n  if (rank === 1) {\n    return `${name}`;\n  } else if (rank === 2) {\n    return `${name}.y`;\n  } else if (rank === 3) {\n    return `${name}.z`;\n  } else if (rank === 4) {\n    return `${name}.w`;\n  } else {\n    throw Error(`Cumulative sum for rank ${rank} is not yet supported`);\n  }\n}","map":{"version":3,"names":["getCoordsDataType","CumSumProgram","constructor","shape","exclusive","reverse","variableNames","outputShape","rank","length","val","getCoords","condition","idxString","userCode","getFinalCoord","getCustomSetupFunc","index","gpgpu","webGLProgram","getUniformLocation","gl","uniform1f","name","Error"],"sources":["../src/cumsum_gpu.ts"],"sourcesContent":[null],"mappings":"AAkBA,SAAQA,iBAAiB,QAAO,mBAAmB;AAEnD,OAAM,MAAOC,aAAa;EAQxBC,YAAYC,KAAe,EAAEC,SAAkB,EAAEC,OAAgB;IAPjE,KAAAC,aAAa,GAAG,CAAC,GAAG,CAAC;IAQnB,IAAI,CAACC,WAAW,GAAGJ,KAAK;IACxB,MAAMK,IAAI,GAAGL,KAAK,CAACM,MAAM;IACzB,MAAMC,GAAG,GAAGN,SAAS,GAAG,KAAK,GAAG,QAAQO,SAAS,CAACH,IAAI,EAAE,QAAQ,CAAC,GAAG;IACpE,MAAMC,MAAM,GAAGN,KAAK,CAACA,KAAK,CAACM,MAAM,GAAG,CAAC,CAAC;IACtC,IAAIG,SAAS,GAAG,EAAE;IAClB,IAAIC,SAAS,GAAG,EAAE;IAClB;IACA;IACA;IACA,IAAIT,SAAS,EAAE;MACbQ,SAAS,GAAGP,OAAO,GAAG,UAAUI,MAAM,GAAG,CAAC,EAAE,GAAG,UAAU;MACzDI,SAAS,GAAGR,OAAO,GAAG,SAAS,GAAG,SAAS;KAC5C,MAAM;MACLO,SAAS,GAAGP,OAAO,GAAG,gBAAgBI,MAAM,EAAE,GAAG,aAAa;MAC9DI,SAAS,GAAIR,OAAO,GAAG,YAAY,GAAG,YAAa;;IAGrD,IAAI,CAACS,QAAQ,GAAG;;;UAGVd,iBAAiB,CAACQ,IAAI,CAAC;oBACbO,aAAa,CAACP,IAAI,EAAE,QAAQ,CAAC;sBAC3BE,GAAG;;cAEXE,SAAS;sBACDC,SAAS;YACnBE,aAAa,CAACP,IAAI,EAAE,QAAQ,CAAC;wBACjBG,SAAS,CAACH,IAAI,EAAE,QAAQ,CAAC;;;;KAI5C;EACH;EAEAQ,kBAAkBA,CAACC,KAAa;IAC9B,OAAO,CAACC,KAAmB,EAAEC,YAA0B,KAAI;MACzD,IAAI,IAAI,CAACF,KAAK,IAAI,IAAI,EAAE;QACtB,IAAI,CAACA,KAAK,GAAGC,KAAK,CAACE,kBAAkB,CAACD,YAAY,EAAE,OAAO,CAAC;;MAE9DD,KAAK,CAACG,EAAE,CAACC,SAAS,CAAC,IAAI,CAACL,KAAK,EAAEA,KAAK,CAAC;IACvC,CAAC;EACH;;AAGF,SAASN,SAASA,CAACH,IAAY,EAAEe,IAAY;EAC3C,IAAIf,IAAI,KAAK,CAAC,EAAE;IACd,OAAO,GAAGe,IAAI,EAAE;GACjB,MAAM,IAAIf,IAAI,KAAK,CAAC,EAAE;IACrB,OAAO,GAAGe,IAAI,OAAOA,IAAI,IAAI;GAC9B,MAAM,IAAIf,IAAI,KAAK,CAAC,EAAE;IACrB,OAAO,GAAGe,IAAI,OAAOA,IAAI,OAAOA,IAAI,IAAI;GACzC,MAAM,IAAIf,IAAI,KAAK,CAAC,EAAE;IACrB,OAAO,GAAGe,IAAI,OAAOA,IAAI,OAAOA,IAAI,OAAOA,IAAI,IAAI;GACpD,MAAM;IACL,MAAMC,KAAK,CAAC,2BAA2BhB,IAAI,uBAAuB,CAAC;;AAEvE;AAEA,SAASO,aAAaA,CAACP,IAAY,EAAEe,IAAY;EAC/C,IAAIf,IAAI,KAAK,CAAC,EAAE;IACd,OAAO,GAAGe,IAAI,EAAE;GACjB,MAAM,IAAIf,IAAI,KAAK,CAAC,EAAE;IACrB,OAAO,GAAGe,IAAI,IAAI;GACnB,MAAM,IAAIf,IAAI,KAAK,CAAC,EAAE;IACrB,OAAO,GAAGe,IAAI,IAAI;GACnB,MAAM,IAAIf,IAAI,KAAK,CAAC,EAAE;IACrB,OAAO,GAAGe,IAAI,IAAI;GACnB,MAAM;IACL,MAAMC,KAAK,CAAC,2BAA2BhB,IAAI,uBAAuB,CAAC;;AAEvE"},"metadata":{},"sourceType":"module"}